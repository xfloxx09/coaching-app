{# app/templates/main/team_view.html #}
{% extends "base.html" %}

{% block head_extra %}
<style>
    .member-card .card-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #343a40; /* Bootstrap default dark text */
        margin-bottom: 0.75rem;
    }
    .member-card .card-body {
        padding: 1.25rem;
    }
    .member-card .stat-group {
        margin-bottom: 1rem;
    }
    .member-card .stat-label {
        font-size: 0.8rem;
        color: #6c757d; /* Bootstrap muted text color */
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.15rem;
        display: block; 
    }
    .member-card .stat-value {
        font-size: 1.3rem;
        font-weight: 500; 
        color: #e20074; /* Telekom Magenta */
    }
    .member-card .stat-value-small {
        font-size: 1rem;
        font-weight: 500;
        color: #e20074;
    }
    .member-card .progress {
        height: 22px; 
        margin-bottom: 1rem; 
        background-color: #dee2e6; 
        border-radius: .25rem; 
    }
    .member-card .progress-bar {
        font-size: 0.85rem;
        line-height: 22px; 
        color: white;
        font-weight: bold;
        text-shadow: 0 0 2px rgba(0,0,0,0.5); 
    }
    .details-link-container {
        margin-top: 1rem; 
    }
    .team-info-card {
        background-color: #f8f9fa; 
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h2 class="mb-2 mb-md-0">{{ title }}</h2>
        {% if all_teams_list and all_teams_list|length > 1 and current_user.role in [config.ROLE_ADMIN, config.ROLE_PROJEKTLEITER, config.ROLE_ABTEILUNGSLEITER, config.ROLE_QM, config.ROLE_SALESCOACH, config.ROLE_TRAINER] %}
        <div class="form-group mb-0">
            <form method="GET" action="{{ url_for('main.team_view') }}" id="selectTeamForm" class="form-inline">
                <label for="team_id_select" class="mr-2 sr-only">Team wechseln:</label>
                <select name="team_id" id="team_id_select" class="form-control custom-select form-control-sm" onchange="this.form.submit()" title="Anderes Team anzeigen">
                    {% for t_opt in all_teams_list %}
                        <option value="{{ t_opt.id }}" {% if team and team.id == t_opt.id %}selected{% endif %}>
                            {{ t_opt.name }}
                        </option>
                    {% endfor %}
                </select>
            </form>
        </div>
        {% endif %}
    </div>

    {% if team %}
        <div class="card team-info-card mb-4 shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong class="stat-label">Team Name:</strong>
                        <p class="stat-value mb-0" style="color: #333;">{{ team.name }}</p>
                    </div>
                    <div class="col-md-4">
                        <strong class="stat-label">Teamleiter:</strong>
                        <p class="stat-value mb-0" style="color: #333;">
                            {{ team.team_leader.username if team.team_leader else '-' }}
                        </p>
                    </div>
                    <div class="col-md-4">
                        <strong class="stat-label">Anzahl Mitglieder:</strong>
                        <p class="stat-value mb-0" style="color: #333;">{{ team.members.count() }}</p>
                    </div>
                </div>
            </div>
        </div>

        {% if team_members_performance %}
            <h4 class="mb-3">Teammitglieder Performance</h4>
            <div class="row">
                {% for member_stat in team_members_performance %}
                <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                    <div class="card member-card h-100 shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-center">{{ member_stat.name }}</h5>
                            <hr class="mt-1 mb-3">
                            
                            <div class="stat-group text-center">
                                <div class="stat-label">Durchschnittlicher Score</div>
                                <div class="progress mx-auto" style="max-width: 200px;">
                                    <div class="progress-bar {% if member_stat.avg_score >= (config.PERFORMANCE_BENCHMARK or 80) %}bg-success{% elif member_stat.avg_score >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                         role="progressbar" 
                                         style="width: {{ member_stat.avg_score }}%;" 
                                         aria-valuenow="{{ member_stat.avg_score }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        {{ member_stat.avg_score }}%
                                    </div>
                                </div>
                            </div>

                            <div class="row text-center mt-auto pt-2"> 
                                <div class="col-6 border-right">
                                    <div class="stat-label">Coachings</div>
                                    <div class="stat-value">{{ member_stat.total_coachings }}</div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-label">Gesamtzeit</div>
                                    <div class="stat-value-small">{{ member_stat.formatted_total_coaching_time }}</div>
                                </div>
                            </div>
                             
                             <div class="text-center details-link-container mt-auto">
                                 {# Link to dashboard filtered by this team member and current team #}
                                 <a href="{{ url_for('main.index', search=member_stat.name, team=team.id if team else 'all', period='all') }}" class="btn btn-sm telekom-button-outline">
                                     Coachings von {{ member_stat.name.split(' ')[0] }}
                                 </a>
                             </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% elif team.members.count() > 0 %}
             <p>Für die Mitglieder dieses Teams wurden noch keine Coachings erfasst oder Performance-Daten berechnet.</p>
        {% else %}
            <p>Dieses Team hat aktuell keine Mitglieder.</p>
        {% endif %}
        <hr class="my-4">
    {% endif %}


    {% if team_coachings %}
        <h4 class="mt-4 mb-3">Letzte Coachings im Team {% if team %}"{{ team.name }}"{% endif %} (Top 10)</h4>
        <div class="table-responsive">
            <table class="table table-sm table-striped table-hover">
                <thead class="telekom-bg-magenta text-white">
                    <tr>
                        <th>Datum</th>
                        <th>Mitglied</th>
                        <th>Coach</th>
                        <th>Betreff</th>
                        <th>Score (%)</th>
                        <th>Aktionen</th> 
                    </tr>
                </thead>
                <tbody>
                    {% for coaching in team_coachings %}
                    <tr>
                        <td>{{ coaching.coaching_date|athens_time('%d.%m.%y %H:%M') }}</td>
                        <td>{{ coaching.team_member_coached.name if coaching.team_member_coached else 'N/A' }}</td>
                        <td>{{ coaching.coach.username if coaching.coach else 'N/A' }}</td>
                        <td>{{ coaching.coaching_subject }}</td>
                        <td>{{ coaching.overall_score }}%</td>
                        <td>
                             {% if current_user.id == coaching.coach_id or current_user.role == config.ROLE_ADMIN %}
                            <a href="{{ url_for('main.edit_coaching', coaching_id=coaching.id, next=request.url) }}" 
                               class="btn btn-xs btn-outline-secondary mr-1" title="Bearbeiten">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% endif %}
                            <button class="btn btn-xs telekom-button-outline" type="button" data-toggle="collapse" data-target="#teamViewCoachingDetails{{ coaching.id }}" aria-expanded="false">
                                Details
                            </button>
                        </td>
                    </tr>
                     <tr class="collapse" id="teamViewCoachingDetails{{ coaching.id }}">
                        <td colspan="6"> 
                            <div class="card card-body">
                                <strong>Stil:</strong> {{ coaching.coaching_style if coaching.coaching_style else '-'}} 
                                {% if coaching.coaching_style == 'TCAP' and coaching.tcap_id %} (ID: {{ coaching.tcap_id }}) {% endif %}<br>
                                <strong>Performance Note (0-10):</strong> {{ coaching.performance_mark }}<br>
                                <strong>Zeitaufwand:</strong> {{ coaching.time_spent }} Min.<br>
                                <hr>
                                <strong>Leitfaden-Checkmarks:</strong><br>
                                <ul class="list-unstyled ml-3">
                                {% for name, value in coaching.leitfaden_fields_list %}
                                    <li>{{ name }}: <strong>{{ value }}</strong></li>
                                {% endfor %}
                                </ul>
                                <strong>Leitfaden Erfüllung:</strong> {{ coaching.leitfaden_erfuellung_display }}
                                
                                {% if coaching.coach_notes %}
                                <hr><strong>Notizen des Coaches:</strong><br><p style="white-space: pre-wrap;">{{ coaching.coach_notes }}</p>
                                {% endif %}
                                {% if coaching.project_leader_notes %}
                                <hr><strong>PL/QM Notiz:</strong><br><p style="white-space: pre-wrap;">{{ coaching.project_leader_notes }}</p>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% elif team %} 
        <p class="mt-4">Für dieses Team wurden im ausgewählten Zeitraum keine Coachings gefunden.</p>
    {% endif %}

    {% if not team and all_teams_list %}
        <h3 class="mt-5 text-center text-muted">Bitte wählen Sie oben ein Team aus der Liste aus.</h3>
    {% elif not team and not all_teams_list and current_user.role not in [config.ROLE_TEAMLEITER] %}
        <p class="mt-5 text-center text-muted">Es sind keine Teams im System vorhanden, die angezeigt werden könnten.</p>
    {% endif %}

</div>
{% endblock %}
