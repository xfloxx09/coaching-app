{# app/templates/main/team_view.html #}
{% extends "base.html" %}

{% block head_extra %}
    {# Font Awesome is linked in your base.html #}
<style>
    /* General Page Adjustments for Dark Theme (if not already in style.css) */
    body { /* Assuming your body is dark from style.css, otherwise uncomment */
        /* background-color: #212529; */
        /* color: #f8f9fa; */
    }
    h2, h3, h4 {
        color: #f8f9fa; /* Light color for headings if body is dark */
    }

    /* Top Team Info Card (Light background, dark text) */
    .team-info-card {
        background-color: #f8f9fa; /* Very light gray, almost white */
        color: #212529; /* Dark text */
        border: 1px solid #dee2e6;
    }
    .team-info-card strong { /* Labels like "Team Name:" */
        color: #495057; /* Slightly less dark than main text */
    }
    .team-info-card p { /* Values like team name, leader name */
        color: #212529;
        font-weight: 500;
    }

    /* Member Performance Cards (Dark background, light text) */
    .member-card {
        background-color: #394047; /* Darker gray for cards, adjust as needed */
        border: 1px solid #555e67; /* Subtle border */
        color: #f8f9fa; /* Default light text for card content */
    }
    .member-card .card-title { /* Member Name */
        font-size: 1.2rem;
        font-weight: bold;
        color: #ffffff; /* White or very light gray */
        margin-bottom: 0.75rem;
        border-bottom: 1px solid #555e67; /* Subtle separator */
        padding-bottom: 0.5rem;
    }
    .member-card .card-body {
        padding: 1.25rem;
    }
    .member-card .stat-group {
        margin-bottom: 1rem;
    }
    .member-card .stat-label { /* "DURCHSCHNITTLICHER SCORE", "COACHINGS", "GESAMTZEIT" */
        font-size: 0.75rem; /* Smaller */
        color: #adb5bd;   /* Lighter muted gray */
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.2rem;
        display: block; 
    }
    .member-card .stat-value { /* Magenta values for coachings/time */
        font-size: 1.3rem;
        font-weight: bold; /* Make magenta stats bold */
        color: #e20074; 
    }
    .member-card .stat-value-small { /* For total time if it needs to be smaller */
        font-size: 1.1rem; /* Adjusted */
        font-weight: bold;
        color: #e20074;
    }
    .member-card .progress {
        height: 20px; 
        margin-bottom: 1rem; 
        background-color: #5a6268; /* Darker background for progress track */
        border-radius: .25rem; 
    }
    .member-card .progress-bar { /* Text inside progress bar */
        font-size: 0.8rem;
        line-height: 20px; 
        color: white;
        font-weight: bold;
        text-shadow: 0 0 2px rgba(0,0,0,0.6); /* Slightly stronger shadow for contrast */
    }
    .details-link-container {
        margin-top: 1rem; 
    }
    /* Assuming telekom-button-outline handles its colors for dark bg */
    /* If not, you might need:
    .member-card .telekom-button-outline {
        color: #e20074 !important;
        border-color: #e20074 !important;
    }
    .member-card .telekom-button-outline:hover {
        background-color: rgba(226, 0, 116, 0.1) !important;
    }
    */

    /* Recent Coachings Table - ensure it's also styled for dark theme if needed */
    .table-sm th, .table-sm td { /* If table text is too dark */
        /* color: #f8f9fa; */ /* Example: making table text light */
    }
    .table-striped tbody tr:nth-of-type(odd) { /* Adjust striped color for dark theme */
        /* background-color: rgba(255, 255, 255, .03); */ /* Very subtle light striping */
    }
    .card.card-body { /* For the collapsible details */
        background-color: #495057; /* Darker background for details */
        color: #f8f9fa;
        border-color: #555e67;
    }
    .card.card-body hr {
        border-top: 1px solid #555e67;
    }

</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h2 class="mb-2 mb-md-0">{{ title }}</h2>
        {% if all_teams_list and all_teams_list|length > 1 and current_user.role in [config.ROLE_ADMIN, config.ROLE_PROJEKTLEITER, config.ROLE_ABTEILUNGSLEITER, config.ROLE_QM, config.ROLE_SALESCOACH, config.ROLE_TRAINER] %}
        <div class="form-group mb-0">
            <form method="GET" action="{{ url_for('main.team_view') }}" id="selectTeamForm" class="form-inline">
                <label for="team_id_select" class="mr-2 sr-only">Team wechseln:</label>
                <select name="team_id" id="team_id_select" class="form-control custom-select form-control-sm" onchange="this.form.submit()" title="Anderes Team anzeigen">
                    {% for t_opt in all_teams_list %}
                        <option value="{{ t_opt.id }}" {% if team and team.id == t_opt.id %}selected{% endif %}>
                            {{ t_opt.name }}
                        </option>
                    {% endfor %}
                </select>
            </form>
        </div>
        {% endif %}
    </div>

    {% if team %}
        <div class="card team-info-card mb-4 shadow-sm"> {# This card will be light with dark text #}
            <div class="card-body">
                <div class="row text-center text-md-left">
                    <div class="col-md-4 mb-2 mb-md-0">
                        <strong>Team Name:</strong>
                        <p class="mb-0">{{ team.name }}</p>
                    </div>
                    <div class="col-md-4 mb-2 mb-md-0">
                        <strong>Teamleiter:</strong>
                        <p class="mb-0">
                            {{ team.team_leader.username if team.team_leader else '-' }}
                        </p>
                    </div>
                    <div class="col-md-4">
                        <strong>Anzahl Mitglieder:</strong>
                        <p class="mb-0">{{ team.members.count() }}</p>
                    </div>
                </div>
            </div>
        </div>

        {% if team_members_performance %}
            <h4 class="mb-3">Teammitglieder Performance</h4>
            <div class="row">
                {% for member_stat in team_members_performance %}
                <div class="col-xl-3 col-lg-4 col-md-6 mb-4"> {# Dark member cards #}
                    <div class="card member-card h-100 shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-center">{{ member_stat.name }}</h5>
                            
                            <div class="stat-group text-center">
                                <div class="stat-label">Durchschnittlicher Score</div>
                                <div class="progress mx-auto" style="max-width: 180px;"> {# Slightly smaller progress bar #}
                                    <div class="progress-bar {% if member_stat.avg_score == 0 and member_stat.total_coachings == 0 %}bg-secondary{% elif member_stat.avg_score >= (config.PERFORMANCE_BENCHMARK or 80) %}bg-success{% elif member_stat.avg_score >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                         role="progressbar" 
                                         style="width: {{ member_stat.avg_score }}%;" 
                                         aria-valuenow="{{ member_stat.avg_score }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        {{ member_stat.avg_score if member_stat.total_coachings > 0 else 'N/A' }}%
                                    </div>
                                </div>
                            </div>

                            <div class="row text-center mt-auto pt-3"> 
                                <div class="col-6 border-right">
                                    <div class="stat-label">Coachings</div>
                                    <div class="stat-value">{{ member_stat.total_coachings }}</div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-label">Gesamtzeit</div>
                                    <div class="stat-value-small">{{ member_stat.formatted_total_coaching_time }}</div>
                                </div>
                            </div>
                             
                             <div class="text-center details-link-container mt-auto">
                                 <a href="{{ url_for('main.index', search=member_stat.name, team=team.id if team else 'all', period='all') }}" class="btn btn-sm telekom-button-outline">
                                     Coachings von {{ member_stat.name.split(' ')[0] }}
                                 </a>
                             </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% elif team.members.count() > 0 %}
             <p>Für die Mitglieder dieses Teams wurden noch keine Coachings erfasst oder Performance-Daten berechnet.</p>
        {% else %}
            <p>Dieses Team hat aktuell keine Mitglieder.</p>
        {% endif %}
        <hr class="my-4" style="border-color: #444;"> {# Darker HR #}
    {% endif %}


    {% if team_coachings %}
        <h4 class="mt-4 mb-3">Letzte Coachings im Team {% if team %}"{{ team.name }}"{% endif %} (Top 10)</h4>
        <div class="table-responsive">
            <table class="table table-sm table-striped table-dark"> {# Added table-dark for better dark theme compatibility #}
                <thead class="telekom-bg-magenta text-white">
                    <tr>
                        <th>Datum</th>
                        <th>Mitglied</th>
                        <th>Coach</th>
                        <th>Betreff</th>
                        <th>Score (%)</th>
                        <th>Aktionen</th> 
                    </tr>
                </thead>
                <tbody>
                    {% for coaching in team_coachings %}
                    <tr>
                        <td>{{ coaching.coaching_date|athens_time('%d.%m.%y %H:%M') }}</td>
                        <td>{{ coaching.team_member_coached.name if coaching.team_member_coached else 'N/A' }}</td>
                        <td>{{ coaching.coach.username if coaching.coach else 'N/A' }}</td>
                        <td>{{ coaching.coaching_subject }}</td>
                        <td>{{ coaching.overall_score }}%</td>
                        <td>
                             {% if current_user.id == coaching.coach_id or current_user.role == config.ROLE_ADMIN %}
                            <a href="{{ url_for('main.edit_coaching', coaching_id=coaching.id, next=request.url) }}" 
                               class="btn btn-xs btn-outline-light mr-1" title="Bearbeiten"> {# Changed to btn-outline-light #}
                                <i class="fas fa-edit"></i>
                            </a>
                            {% endif %}
                            <button class="btn btn-xs telekom-button-outline" type="button" data-toggle="collapse" data-target="#teamViewCoachingDetails{{ coaching.id }}" aria-expanded="false">
                                Details
                            </button>
                        </td>
                    </tr>
                     <tr class="collapse" id="teamViewCoachingDetails{{ coaching.id }}">
                        <td colspan="6"> 
                            <div class="card card-body"> {# This will inherit dark styles defined above #}
                                <strong>Stil:</strong> {{ coaching.coaching_style if coaching.coaching_style else '-'}} 
                                {% if coaching.coaching_style == 'TCAP' and coaching.tcap_id %} (ID: {{ coaching.tcap_id }}) {% endif %}<br>
                                <strong>Performance Note (0-10):</strong> {{ coaching.performance_mark }}<br>
                                <strong>Zeitaufwand:</strong> {{ coaching.time_spent }} Min.<br>
                                <hr>
                                <strong>Leitfaden-Checkmarks:</strong><br>
                                <ul class="list-unstyled ml-3">
                                {% for name, value in coaching.leitfaden_fields_list %}
                                    <li>{{ name }}: <strong>{{ value }}</strong></li>
                                {% endfor %}
                                </ul>
                                <strong>Leitfaden Erfüllung:</strong> {{ coaching.leitfaden_erfuellung_display }}
                                
                                {% if coaching.coach_notes %}
                                <hr><strong>Notizen des Coaches:</strong><br><p style="white-space: pre-wrap;">{{ coaching.coach_notes }}</p>
                                {% endif %}
                                {% if coaching.project_leader_notes %}
                                <hr><strong>PL/QM Notiz:</strong><br><p style="white-space: pre-wrap;">{{ coaching.project_leader_notes }}</p>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% elif team %} 
        <p class="mt-4">Für dieses Team wurden im ausgewählten Zeitraum keine Coachings gefunden.</p>
    {% endif %}

    {% if not team and all_teams_list %}
        <h3 class="mt-5 text-center text-muted">Bitte wählen Sie oben ein Team aus der Liste aus.</h3>
    {% elif not team and not all_teams_list and current_user.role not in [config.ROLE_TEAMLEITER] %}
        <p class="mt-5 text-center text-muted">Es sind keine Teams im System vorhanden, die angezeigt werden könnten.</p>
    {% endif %}

</div>
{% endblock %}
