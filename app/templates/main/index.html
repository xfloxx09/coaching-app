{% extends "base.html" %}

{% block head_extra %}
<style>
    /* Optional: Style for the progress bar text to be more visible */
    .progress-bar {
        color: white;
        font-weight: bold;
        text-shadow: 1px 1px 1px rgba(0,0,0,0.4);
    }
    .table th.telekom-header { /* For the specific magenta header for the table */
        background-color: #e20074; /* Telekom Magenta */
        color: white;
    }
</style>
{% endblock %}


{% block content %}
<div class="container-fluid"> {# Changed to container-fluid for more space if needed #}
    <h1 class="mb-4">{{ title }}</h1>

    {# Row for Filters and Search #}
    <div class="row mb-3 align-items-end">
        {# Column for Period and Team Filters #}
        <div class="col-md-8 col-lg-9">
            <form method="GET" action="{{ url_for('main.index') }}" class="form-inline">
                {# Hidden input to carry over search term when changing other filters #}
                {% if current_search_term %}
                    <input type="hidden" name="search" value="{{ current_search_term }}">
                {% endif %}

                <div class="form-group mr-2 mb-2">
                    <label for="period_filter" class="mr-1">Zeitraum:</label>
                    <select name="period" id="period_filter" class="form-control form-control-sm" onchange="this.form.submit()">
                        <option value="all" {% if current_period_filter == 'all' %}selected{% endif %}>Alles</option>
                        <option value="7days" {% if current_period_filter == '7days' %}selected{% endif %}>Letzte 7 Tage</option>
                        <option value="30days" {% if current_period_filter == '30days' %}selected{% endif %}>Letzte 30 Tage</option>
                        <option value="current_quarter" {% if current_period_filter == 'current_quarter' %}selected{% endif %}>Aktuelles Quartal</option>
                        <option value="current_year" {% if current_period_filter == 'current_year' %}selected{% endif %}>Aktuelles Jahr</option>
                    </select>
                </div>

                {% if current_user.role != 'Teamleiter' and all_teams_for_filter %}
                <div class="form-group mr-2 mb-2">
                    <label for="team_filter" class="mr-1">Team:</label>
                    <select name="team" id="team_filter" class="form-control form-control-sm" onchange="this.form.submit()">
                        <option value="all" {% if current_team_id_filter == 'all' or not current_team_id_filter.isdigit() %}selected{% endif %}>Alle Teams</option>
                        {% for team_item_filter in all_teams_for_filter %} {# Renamed loop var #}
                        <option value="{{ team_item_filter.id }}" {% if current_team_id_filter == team_item_filter.id|string %}selected{% endif %}>{{ team_item_filter.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
            </form>
        </div>

        {# Column for Search Box - aligned to the right #}
        <div class="col-md-4 col-lg-3">
            <form method="GET" action="{{ url_for('main.index') }}" class="form-inline float-md-right w-100" role="search">
                <input type="hidden" name="period" value="{{ current_period_filter }}">
                <input type="hidden" name="team" value="{{ current_team_id_filter }}">

                <div class="input-group w-100 mb-2">
                    <input type="text" name="search" class="form-control form-control-sm" placeholder="Suchen..." value="{{ current_search_term or '' }}" aria-label="Suchbegriff">
                    <div class="input-group-append">
                        <button type="submit" class="btn btn-primary btn-sm">Suchen</button>
                        {% if current_search_term %}
                            <a href="{{ url_for('main.index', period=current_period_filter, team=current_team_id_filter) }}" class="btn btn-outline-secondary btn-sm" title="Suche zurücksetzen">×</a>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="clearfix"></div>


    {# --- Summary Boxes --- #}
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Gefilterte Coachings</h5>
                    <p class="card-text display-4">{{ total_filtered_coachings_count }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Zeitaufwand (gefiltert)</h5>
                    <p class="card-text display-4">{{ time_coached_display }}</p>
                </div>
            </div>
        </div>
    </div>


    {# --- Coaching List --- #}
    <h3 class="mt-4">Coaching Liste (Angezeigt: {{ coachings_paginated.items|length }}, Gesamt gefiltert: {{ coachings_paginated.total }})</h3>
    {% if coachings_paginated.items %}
    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered"> {# Added table-bordered for better cell definition #}
            <thead class="thead-dark"> {# Using thead-dark as in your image, can be changed to telekom-header class #}
                 <tr>
                    <th class="telekom-header">Datum</th>
                    <th class="telekom-header">Teammitglied</th>
                    <th class="telekom-header">Team</th>
                    <th class="telekom-header">Coach</th>
                    <th class="telekom-header">Thema</th>
                    <th class="telekom-header">Stil</th>
                    <th class="telekom-header">Note (0-10)</th>
                    <th class="telekom-header">Zeit (Min)</th>
                    <th class="telekom-header">Score (%)</th>
                    <th class="telekom-header">Notiz Coach</th>
                    <th class="telekom-header">Notiz PL/QM</th>
                    <th class="telekom-header">Details</th>
                </tr>
            </thead>
            <tbody>
                {% for coaching in coachings_paginated.items %}
                <tr>
                    <td>{{ coaching.coaching_date|athens_time }}</td>
                    {# CORRECTED relationship access based on models.py #}
                    <td>{{ coaching.team_member_coached.name if coaching.team_member_coached else 'N/A' }}</td>
                    <td>{{ coaching.team_member_coached.team.name if coaching.team_member_coached and coaching.team_member_coached.team else 'N/A' }}</td>
                    <td>{{ coaching.coach.username if coaching.coach else 'N/A' }}</td>
                    <td>{{ coaching.coaching_subject }}</td>
                    <td>{{ coaching.coaching_style }}</td>
                    <td>{{ coaching.performance_mark }}</td>
                    <td>{{ coaching.time_spent }}</td>
                    <td>
                        <div class="progress" style="height: 20px; background-color: #6c757d;">
                             <div class="progress-bar {% if (coaching.performance_mark * 10) >= 80 %}bg-success{% elif (coaching.performance_mark * 10) >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                                 role="progressbar"
                                 style="width: {{ coaching.performance_mark * 10 }}%;"
                                 aria-valuenow="{{ coaching.performance_mark * 10 }}"
                                 aria-valuemin="0" aria-valuemax="100">
                                 {{ "%.1f"|format(coaching.performance_mark * 10) }}%
                             </div>
                         </div>
                    </td>
                    <td>{{ coaching.coach_notes|truncate(30, True) if coaching.coach_notes else '-' }}</td>
                    <td>{{ coaching.project_leader_notes|truncate(30, True) if coaching.project_leader_notes else '-' }}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#coachingDetailsModal-{{ coaching.id }}">
                            Details
                        </button>
                    </td>
                </tr>

                {# Modal for each coaching - using correct relationships #}
                <div class="modal fade" id="coachingDetailsModal-{{ coaching.id }}" tabindex="-1" role="dialog" aria-labelledby="coachingDetailsModalLabel-{{ coaching.id }}" aria-hidden="true">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="coachingDetailsModalLabel-{{ coaching.id }}">Coaching Details: {{ coaching.team_member_coached.name if coaching.team_member_coached }} am {{ coaching.coaching_date|athens_time('%d.%m.%Y') }}</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">×</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p><strong>Teammitglied:</strong> {{ coaching.team_member_coached.name if coaching.team_member_coached else 'N/A' }}</p>
                                <p><strong>Team:</strong> {{ coaching.team_member_coached.team.name if coaching.team_member_coached and coaching.team_member_coached.team else 'N/A' }}</p>
                                <p><strong>Coach:</strong> {{ coaching.coach.username if coaching.coach else 'N/A' }}</p>
                                <p><strong>Datum:</strong> {{ coaching.coaching_date|athens_time }}</p>
                                <p><strong>Stil:</strong> {{ coaching.coaching_style }}{% if coaching.coaching_style == 'TCAP' and coaching.tcap_id %} (ID: {{ coaching.tcap_id }}){% endif %}</p>
                                <p><strong>Thema:</strong> {{ coaching.coaching_subject }}</p>
                                <hr>
                                <p><strong>Leitfadenpunkte:</strong> (Erfüllung: {{ coaching.leitfaden_erfuellung_display }})</p>
                                <ul>
                                    {% for name, value in coaching.leitfaden_fields_list %}
                                    <li>{{ name }}: {{ value }}</li>
                                    {% endfor %}
                                </ul>
                                <hr>
                                <p><strong>Performance Note (0-10):</strong> {{ coaching.performance_mark }}</p>
                                <p><strong>Score:</strong> {{ coaching.overall_score }}%</p> {# Using the overall_score property #}
                                <p><strong>Zeitaufwand:</strong> {{ coaching.time_spent }} Minuten</p>
                                <hr>
                                <p><strong>Notizen des Coaches:</strong></p>
                                <pre>{{ coaching.coach_notes if coaching.coach_notes else 'Keine Notizen.' }}</pre>
                                <hr>
                                <p><strong>Notizen des PL/QM:</strong></p>
                                <pre>{{ coaching.project_leader_notes if coaching.project_leader_notes else 'Keine Notizen.' }}</pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
                                {# Add edit button if applicable #}
                                {# {% if current_user.can_edit_coaching(coaching) %} #}
                                {# <a href="{{ url_for('admin.edit_coaching', coaching_id=coaching.id) }}" class="btn btn-primary">Bearbeiten</a> #}
                                {# {% endif %} #}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# Pagination Links - Ensuring search term is passed #}
    <nav aria-label="Coaching Navigation">
        <ul class="pagination justify-content-center">
            {% if coachings_paginated.has_prev %}
                <li class="page-item"><a class="page-link" href="{{ url_for('main.index', page=coachings_paginated.prev_num, period=current_period_filter, team=current_team_id_filter, search=current_search_term) }}">Vorherige</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Vorherige</span></li>
            {% endif %}

            {% for page_num in coachings_paginated.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                {% if page_num %}
                    {% if coachings_paginated.page == page_num %}
                        <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
                    {% else %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('main.index', page=page_num, period=current_period_filter, team=current_team_id_filter, search=current_search_term) }}">{{ page_num }}</a></li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            {% if coachings_paginated.has_next %}
                <li class="page-item"><a class="page-link" href="{{ url_for('main.index', page=coachings_paginated.next_num, period=current_period_filter, team=current_team_id_filter, search=current_search_term) }}">Nächste</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Nächste</span></li>
            {% endif %}
        </ul>
    </nav>
    {% else %}
        <p class="text-center">Keine Coachings gefunden, die den aktuellen Filtern entsprechen.</p>
    {% endif %}


    {# --- Charts --- #}
    <div class="row mt-5">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Team Performance Durchschnitt</div>
                <div class="card-body">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
             <div class="card shadow-sm">
                <div class="card-header">Coaching Themen Verteilung</div>
                <div class="card-body">
                    <canvas id="subjectChart"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Performance Chart
    var ctxPerformance = document.getElementById('performanceChart')?.getContext('2d');
    if (ctxPerformance && typeof Chart !== 'undefined' && {{ chart_labels|tojson|safe }}.length > 0) {
        var performanceChart = new Chart(ctxPerformance, {
            type: 'bar',
            data: {
                labels: {{ chart_labels|tojson|safe }},
                datasets: [{
                    label: 'Durchschnittliche Performance Note (%)',
                    data: {{ chart_avg_performance_mark_percentage|tojson|safe }},
                    backgroundColor: 'rgba(226, 0, 116, 0.6)', // Telekom Magenta slightly transparent
                    borderColor: 'rgba(226, 0, 116, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Durchschnittliche Coaching Dauer (Min)',
                    data: {{ chart_avg_time_spent|tojson|safe }},
                    type: 'line',
                    borderColor: 'rgba(0, 169, 224, 1)', // Telekom Blue
                    backgroundColor: 'rgba(0, 169, 224, 0.2)',
                    yAxisID: 'yTime',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: 'Performance (%)' }
                    },
                    yTime: {
                        beginAtZero: true,
                        position: 'right',
                        title: { display: true, text: 'Dauer (Min)'},
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    } else if (ctxPerformance) {
        ctxPerformance.font = "16px Arial";
        ctxPerformance.fillStyle = "#888";
        ctxPerformance.textAlign = "center";
        ctxPerformance.fillText("Keine Daten für Performance Chart verfügbar.", ctxPerformance.canvas.width / 2, ctxPerformance.canvas.height / 2);
    }


    // Subject Distribution Chart
    var ctxSubject = document.getElementById('subjectChart')?.getContext('2d');
    if (ctxSubject && typeof Chart !== 'undefined' && {{ subject_chart_labels|tojson|safe }}.length > 0) {
        var subjectChart = new Chart(ctxSubject, {
            type: 'doughnut',
            data: {
                labels: {{ subject_chart_labels|tojson|safe }},
                datasets: [{
                    label: 'Coaching Themen',
                    data: {{ subject_chart_values|tojson|safe }},
                    backgroundColor: [
                        'rgba(226, 0, 116, 0.7)',
                        'rgba(0, 169, 224, 0.7)',
                        'rgba(128, 128, 128, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Verteilung der Coaching Themen'
                    }
                }
            }
        });
    } else if (ctxSubject) {
        ctxSubject.font = "16px Arial";
        ctxSubject.fillStyle = "#888";
        ctxSubject.textAlign = "center";
        ctxSubject.fillText("Keine Daten für Themen Chart verfügbar.", ctxSubject.canvas.width / 2, ctxSubject.canvas.height / 2);
    }
});
</script>
{% endblock %}
