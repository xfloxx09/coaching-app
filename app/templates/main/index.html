{% extends "base.html" %}

{% block content %}
<h2>{{ title }} (Gesamt: {{ total_coachings if total_coachings is not none else 0 }})</h2>

{% if coachings_paginated and coachings_paginated.items %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="telekom-bg-magenta text-white">
                <tr>
                    <th>Datum</th>
                    <th>Teammitglied</th>
                    <th>Team</th>
                    <th>Coach</th>
                    <th>Stil</th>
                    <th>T-CAP ID</th>
                    <th>Note (0-10)</th>
                    <th>Zeit (Min)</th>
                    <th>Score (%)</th>
                    <th>PL Notiz</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% for coaching in coachings_paginated.items %}
                <tr>
                    <td>{{ coaching.coaching_date.strftime('%d.%m.%Y %H:%M') }}</td>
                    <td>{{ coaching.team_member_coached.name }}</td>
                    <td>{{ coaching.team_member_coached.team.name }}</td>
                    <td>{{ coaching.coach.username }}</td>
                    <td>{{ coaching.coaching_style }}</td>
                    <td>{{ coaching.tcap_id if coaching.tcap_id else '-' }}</td>
                    <td>{{ coaching.performance_mark }}</td>
                    <td>{{ coaching.time_spent }}</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar telekom-progress-bar" role="progressbar" style="width: {{ coaching.overall_score }}%;" aria-valuenow="{{ coaching.overall_score }}" aria-valuemin="0" aria-valuemax="100">
                                {{ coaching.overall_score }}%
                            </div>
                        </div>
                    </td>
                    <td>{{ coaching.project_leader_notes[:30] + '...' if coaching.project_leader_notes and coaching.project_leader_notes|length > 30 else coaching.project_leader_notes if coaching.project_leader_notes else '-' }}</td>
                    <td>
                        <button class="btn btn-sm telekom-button-outline" type="button" data-toggle="collapse" data-target="#coachingDetails{{ coaching.id }}" aria-expanded="false" aria-controls="coachingDetails{{ coaching.id }}">
                            Details
                        </button>
                    </td>
                </tr>
                <tr class="collapse" id="coachingDetails{{ coaching.id }}">
                    <td colspan="11">
                        <div class="card card-body">
                            <strong>Leitfaden:</strong><br>
                            Begrüßung: {{ coaching.leitfaden_begruessung }} |
                            Legitimation: {{ coaching.leitfaden_legitimation }} |
                            PKA: {{ coaching.leitfaden_pka }} |
                            KEK: {{ coaching.leitfaden_kek }} |
                            Angebot: {{ coaching.leitfaden_angebot }} |
                            Zusammenfassung: {{ coaching.leitfaden_zusammenfassung }} |
                            KZB: {{ coaching.leitfaden_kzb }} <br>
                            <strong>Leitfaden Erfüllung:</strong> {{ "%.2f"|format(coaching.leitfaden_score_details) }}%
                            {% if coaching.project_leader_notes %}
                            <hr>
                            <strong>Notiz Projektleiter:</strong><br>
                            <p style="white-space: pre-wrap;">{{ coaching.project_leader_notes }}</p>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <nav aria-label="Coaching Navigation">
        <ul class="pagination justify-content-center">
            {% if coachings_paginated.has_prev %}
                <li class="page-item"><a class="page-link telekom-page-link" href="{{ url_for('main.index', page=coachings_paginated.prev_num) }}">Vorherige</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Vorherige</span></li>
            {% endif %}
            
            {% for page_num in coachings_paginated.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                {% if page_num %}
                    {% if coachings_paginated.page == page_num %}
                        <li class="page-item active"><span class="page-link telekom-page-active">{{ page_num }}</span></li>
                    {% else %}
                        <li class="page-item"><a class="page-link telekom-page-link" href="{{ url_for('main.index', page=page_num) }}">{{ page_num }}</a></li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            {% if coachings_paginated.has_next %}
                <li class="page-item"><a class="page-link telekom-page-link" href="{{ url_for('main.index', page=coachings_paginated.next_num) }}">Nächste</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Nächste</span></li>
            {% endif %}
        </ul>
    </nav>

{% else %}
    <p>Noch keine Coachings vorhanden oder Ihnen wurden keine zugewiesen.</p>
{% endif %}
{% if current_user.role in ['Teamleiter', 'Qualitätsmanager', 'SalesCoach', 'Trainer', 'Admin'] %}
<a href="{{ url_for('main.add_coaching') }}" class="btn telekom-button mt-3">Neues Coaching hinzufügen</a>
{% endif %}
{% endblock %}